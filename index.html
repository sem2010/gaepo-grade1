<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>증발과 확산 시뮬레이션</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
    canvas { border: 2px solid #333; margin: 20px auto; display: block; background: #ffffff; }
    .question { margin: 10px 0; }
    .answer { margin-bottom: 20px; width: 80%; }
    button, input[type=range] { margin: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>🌿 증발과 확산 시뮬레이션</h1>
  
  <div>
    <label for="temperature">🌡 온도:</label>
    <input type="range" id="temperature" min="0" max="100" value="25" oninput="updateTemperature(this.value)">
    <span id="tempValue">25°C</span>
  </div>

  <button onclick="startEvaporation()">💧 증발 시뮬레이션</button>
  <button onclick="startDiffusion()">🌬 확산 시뮬레이션</button>

  <canvas id="simCanvas" width="400" height="400"></canvas>
  
  <div id="questionForm" style="display:none;">
    <h2>질문에 답해주세요</h2>
    <div id="questions"></div>
    <input type="text" id="studentName" placeholder="학번 입력" /><br><br>
    <button onclick="submitAnswers()">제출하기</button>
  </div>

  <script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animationInterval = null;
    let currentSimulation = "";
    let temperature = 25;

    function updateTemperature(val) {
      temperature = parseInt(val);
      document.getElementById('tempValue').innerText = `${val}K`;
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawParticles() {
      clearCanvas();
      ctx.fillStyle = "#cccccc";
      ctx.fillRect(50, 350, 300, 10); // 바닥
      ctx.fillRect(50, 50, 10, 300);  // 왼쪽 벽
      ctx.fillRect(340, 50, 10, 300); // 오른쪽 벽
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2.5, 0, 2 * Math.PI);
        ctx.fillStyle = p.color;
        ctx.fill();
      });
    }

    function startEvaporation() {
      currentSimulation = "증발 시뮬레이션";
      showQuestions(currentSimulation);

      particles = [];
      const spacing = 6;
      const startX = 60, endX = 330, startY = 60, endY = 340;

      for (let y = startY; y <= endY; y += spacing) {
        for (let x = startX; x <= endX; x += spacing) {
          particles.push({
            x: x + (Math.random() - 0.5) * 2,
            y: y + (Math.random() - 0.5) * 2,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            state: 'liquid',
            color: 'blue'
          });
        }
      }
      animateEvaporation();
    }

    function animateEvaporation() {
      if (animationInterval) clearInterval(animationInterval);
      animationInterval = setInterval(() => {
        particles.forEach(p => {
          if (p.state === 'liquid') {
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < 60 || p.x > 330) p.vx *= -1;
            if (p.y < 60 || p.y > 340) p.vy *= -1;
          }
        });

        const surfaceY = Math.min(...particles.filter(p => p.state === 'liquid').map(p => p.y));
        const evaporationRate = temperature / 1000; // 온도 비례 확률
        particles.filter(p => p.state === 'liquid' && Math.abs(p.y - surfaceY) < 3)
          .forEach(p => {
            if (Math.random() < evaporationRate) {
              p.state = 'gas';
              p.vx = (Math.random() - 0.5) * 2;
              p.vy = -Math.random() * 2 - 1;
              p.color = 'lightblue';
            }
          });

        particles.forEach(p => {
          if (p.state === 'gas') {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.02;
          }
        });

        drawParticles();
      }, 50);
    }

    function startDiffusion() {
      currentSimulation = "확산 시뮬레이션";
      showQuestions(currentSimulation);

      particles = [];
      for (let i = 0; i < 100; i++) {
        particles.push({
          x: 200 + (Math.random() - 0.5) * 20,
          y: 200 + (Math.random() - 0.5) * 20,
          vx: 0, vy: 0,
          color: 'green'
        });
      }
      animateDiffusion();
    }

    function animateDiffusion() {
      if (animationInterval) clearInterval(animationInterval);
      animationInterval = setInterval(() => {
        const diffusionSpeed = temperature / 50; // 온도 비례 확산 속도
        particles.forEach(p => {
          p.vx += (Math.random() - 0.5) * diffusionSpeed;
          p.vy += (Math.random() - 0.5) * diffusionSpeed;
          p.x += p.vx;
          p.y += p.vy;
          p.vx *= 0.95;
          p.vy *= 0.95;
        });
        drawParticles();
      }, 50);
    }

    function showQuestions(simulationType) {
      const questionList = document.getElementById('questions');
      questionList.innerHTML = '';
      const questions = simulationType === '증발 시뮬레이션' ? [
        "1. 증발은 어떤 원리로 일어나나요?",
        "2. 증발은 어떤 상황에서 더 빨리 일어나나요?"
      ] : [
        "1. 확산은 어떤 원리로 일어나나요?",
        "2. 확산 속도에 영향을 주는 요인은 무엇인가요?"
      ];
      questions.forEach((q, i) => {
        questionList.innerHTML += `<div class="question">${q}<br>
          <input class="answer" type="text" id="answer${i}" placeholder="답변 입력" /></div>`;
      });
      document.getElementById('questionForm').style.display = 'block';
    }

    function submitAnswers() {
      const name = document.getElementById('studentName').value.trim();
      if (!name) {
        alert("학번을 입력해주세요.");
        return;
      }
      const answers = [];
      const questionDivs = document.querySelectorAll('.question');
      questionDivs.forEach((qDiv, i) => {
        answers.push({
          question: qDiv.innerText.split('\n')[0],
          answer: document.getElementById(`answer${i}`).value.trim()
        });
      });
      google.script.run.withSuccessHandler(() => {
        alert("제출이 완료되었습니다!");
        location.reload();
      }).saveAnswers({
        name: name,
        simulation: currentSimulation,
        answers: answers
      });
    }
  </script>
</body>
</html>
